# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  EasyQ Backend â€” CI/CD Pipeline
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  Triggers:
#    - Push to main/develop    â†’ Full CI + Docker build
#    - Pull Request to main    â†’ CI only (lint + build)
#
#  Flow:
#    1. CI: Install â†’ Lint â†’ Build (TypeScript)
#    2. CD: Build Docker image â†’ Push to Docker Hub â†’ Deploy
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸš€ EasyQ Backend CI/CD

on:
  # Run on push to main or develop
  push:
    branches: [main, develop]

  # Run on pull requests targeting main
  pull_request:
    branches: [main]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Environment variables used across jobs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  NODE_VERSION: "20"
  DOCKER_IMAGE_NAME: easyq-backend

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: CI â€” Lint & Build
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci:
    name: ğŸ” Lint & Build
    runs-on: ubuntu-latest

    steps:
      # 1. Get the code from GitHub
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Set up Node.js with caching
      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # 3. Install dependencies (clean install)
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 4. Lint the code
      - name: ğŸ” Lint check
        run: npm run lint

      # 5. Build TypeScript â†’ JavaScript
      - name: ğŸ—ï¸ Build
        run: npm run build

      # 6. Upload build artifacts (optional, useful for debugging)
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: backend-build
          path: build/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Docker â€” Build & Push Image
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker:
    name: ğŸ³ Docker Build & Push
    runs-on: ubuntu-latest
    needs: ci # Only runs if CI passes
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Login to Docker Hub
      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Set up Docker Buildx (for multi-platform builds)
      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build and push the Docker image
      - name: ğŸ³ Build & Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Deploy (Example â€” uncomment when ready)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # deploy:
  #   name: ğŸš€ Deploy to Production
  #   runs-on: ubuntu-latest
  #   needs: docker
  #   if: github.ref == 'refs/heads/main'
  #
  #   steps:
  #     # Option A: Deploy to a VPS via SSH
  #     - name: ğŸš€ Deploy to Server
  #       uses: appleboy/ssh-action@v1
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SERVER_SSH_KEY }}
  #         script: |
  #           docker pull ${{ secrets.DOCKERHUB_USERNAME }}/easyq-backend:latest
  #           docker compose -f /app/docker-compose.yml up -d --no-deps backend
  #
  #     # Option B: Deploy to Render
  #     # - name: ğŸš€ Trigger Render Deploy
  #     #   run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
  #
  #     # Option C: Deploy to Railway
  #     # - name: ğŸš€ Trigger Railway Deploy
  #     #   run: railway up --service easyq-backend
