# ═══════════════════════════════════════════════════════════════
#  EasyQ — Production Docker Compose
# ═══════════════════════════════════════════════════════════════
#  Using:
#  - EasyQ Node.js Backend
#  - Nginx Proxy (Auto-Routes Traffic to Backend)
#  - Let's Encrypt ACME Companion (Auto-Generates Free HTTPS Certificates)
# ═══════════════════════════════════════════════════════════════

name: easyq-prod

services:
  # ──────────────────────────────────────────
  # Backend API
  # ──────────────────────────────────────────
  backend:
    container_name: easyq-backend
    # Uses the Docker Hub image pulled through CI/CD instead of manually building it
    image: ${DOCKERHUB_USERNAME}/easyq-backend:latest
    env_file:
      - ./.env.production
    environment:
      - NODE_ENV=production
      - PORT=7004
      # Nginx-Proxy Config to catch incoming requests
      - VIRTUAL_HOST=api.easyq.shibinsiyad.site
      - VIRTUAL_PORT=7004
      # Let's Encrypt Config to auto-generate HTTPS certificates
      - LETSENCRYPT_HOST=api.easyq.shibinsiyad.site
      - LETSENCRYPT_EMAIL=shibinsiyad.k.kdpm@gmail.com # Replaced with your email for SSL renewals
    expose:
      - "7004"
    restart: always
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ──────────────────────────────────────────
  # Reverse Proxy (Handles the HTTP/HTTPS Web Traffic & WebSockets)
  # ──────────────────────────────────────────
  nginx-proxy:
    container_name: easyq-nginx-proxy
    image: nginxproxy/nginx-proxy:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - certs:/etc/nginx/certs
      - vhost:/etc/nginx/vhost.d
      - html:/usr/share/nginx/html
      - /var/run/docker.sock:/tmp/docker.sock:ro
    restart: always

  # ──────────────────────────────────────────
  # Let's Encrypt Companion (Auto-Generates SSL Certificates)
  # ──────────────────────────────────────────
  acme-companion:
    container_name: easyq-acme-companion
    image: nginxproxy/acme-companion
    environment:
      - DEFAULT_EMAIL=shibinsiyad.k.kdpm@gmail.com # Replaced with your email
    volumes:
      - certs:/etc/nginx/certs:rw
      - vhost:/etc/nginx/vhost.d:rw
      - html:/usr/share/nginx/html:rw
      - acme:/etc/acme.sh:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - nginx-proxy
    restart: always

# Persistent storage for SSL certificates so they don't reset when restarting containers
volumes:
  certs:
  vhost:
  html:
  acme:
